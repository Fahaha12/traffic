# ä¸´æ—¶æ–‡ä»¶æ¸…ç†æŒ‡å—

## æ¦‚è¿°

æœ¬ç³»ç»ŸåŒ…å«è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼Œç”¨äºæ¸…ç†HLSæµåª’ä½“æ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ç­‰ï¼Œé˜²æ­¢ç£ç›˜ç©ºé—´è¢«ä¸´æ—¶æ–‡ä»¶å æ»¡ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ—‚ï¸ è‡ªåŠ¨æ¸…ç†ç›®å½•
- **streams/**: HLSæµåª’ä½“æ–‡ä»¶ï¼ˆ.m3u8, .ts, .mp4ç­‰ï¼‰
- **temp/**: ä¸´æ—¶æ–‡ä»¶ï¼ˆ.tmp, .temp, .logç­‰ï¼‰
- **uploads/**: ä¸Šä¼ æ–‡ä»¶ï¼ˆ.mp4, .avi, .movç­‰ï¼‰
- **logs/**: æ—¥å¿—æ–‡ä»¶ï¼ˆ.logï¼‰
- **cache/**: ç¼“å­˜æ–‡ä»¶ï¼ˆ.cache, .tmpï¼‰

### â° æ¸…ç†ç­–ç•¥
- **å¿«é€Ÿæ¸…ç†**: æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- **æ¯æ—¥æ¸…ç†**: å‡Œæ™¨2ç‚¹æ‰§è¡Œæ·±åº¦æ¸…ç†
- **æ¯å‘¨æ¸…ç†**: å‘¨æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œå®Œæ•´æ¸…ç†

### ğŸ›¡ï¸ å®‰å…¨è®¾ç½®
- åªæ¸…ç†æŒ‡å®šæ‰©å±•åçš„æ–‡ä»¶
- æ’é™¤é…ç½®æ–‡ä»¶ï¼ˆ.config, .conf, .iniç­‰ï¼‰
- è®¾ç½®æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶
- æ”¯æŒå¹²è¿è¡Œæ¨¡å¼ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰

## ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å¯åŠ¨æ¸…ç†æœåŠ¡ï¼š

```bash
# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆè‡ªåŠ¨åŒ…å«æ¸…ç†æœåŠ¡ï¼‰
cd backend
python cloud_app.py
```

### 2. æ‰‹åŠ¨æ¸…ç†

#### æ‰§è¡Œä¸€æ¬¡æ¸…ç†
```bash
cd backend
python cleanup_temp_files.py --once
```

#### å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹
```bash
cd backend
python cleanup_temp_files.py --daemon
```

#### æŸ¥çœ‹ä½¿ç”¨æƒ…å†µæŠ¥å‘Š
```bash
cd backend
python cleanup_temp_files.py --report
```

### 3. ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬ï¼ˆWindowsï¼‰

```bash
# åŒå‡»è¿è¡Œæˆ–åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ
backend/start_cleanup.bat
```

### 4. ä½¿ç”¨Shellè„šæœ¬ï¼ˆLinux/Macï¼‰

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x backend/start_cleanup.sh

# è¿è¡Œè„šæœ¬
./backend/start_cleanup.sh
```

## APIæ¥å£

### æ‰‹åŠ¨è§¦å‘æ¸…ç†
```http
POST /api/system/cleanup
```

### è·å–æ¸…ç†çŠ¶æ€
```http
GET /api/system/cleanup/status
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": "active",
  "usage_info": {
    "streams": {
      "size": 1048576,
      "files": 5,
      "path": "streams"
    },
    "temp": {
      "size": 512000,
      "files": 3,
      "path": "temp"
    }
  },
  "last_cleanup": "2025-09-08T15:30:00.000Z"
}
```

## é…ç½®è¯´æ˜

### æ¸…ç†é…ç½®æ–‡ä»¶ (cleanup_config.json)

```json
{
  "cleanup_settings": {
    "enabled": true,
    "base_directory": ".",
    "log_file": "cleanup.log"
  },
  "directories": {
    "streams": {
      "path": "streams",
      "enabled": true,
      "max_age_hours": 2,
      "extensions": [".m3u8", ".ts", ".mp4"]
    }
  },
  "schedules": {
    "quick_cleanup": {
      "interval_minutes": 30,
      "enabled": true
    }
  }
}
```

### ä¸»è¦é…ç½®é¡¹

- **max_age_hours**: æ–‡ä»¶æœ€å¤§ä¿ç•™æ—¶é—´ï¼ˆå°æ—¶ï¼‰
- **extensions**: è¦æ¸…ç†çš„æ–‡ä»¶æ‰©å±•å
- **enabled**: æ˜¯å¦å¯ç”¨è¯¥ç›®å½•çš„æ¸…ç†
- **interval_minutes**: æ¸…ç†é—´éš”ï¼ˆåˆ†é’Ÿï¼‰

## æ—¥å¿—æ–‡ä»¶

æ¸…ç†æ“ä½œä¼šè®°å½•åœ¨ä»¥ä¸‹ä½ç½®ï¼š
- **cleanup.log**: æ¸…ç†æ“ä½œæ—¥å¿—
- **æ§åˆ¶å°è¾“å‡º**: å®æ—¶æ¸…ç†çŠ¶æ€

æ—¥å¿—ç¤ºä¾‹ï¼š
```
2025-09-08 15:30:00 - INFO - å¼€å§‹æ‰§è¡Œå®šæ—¶æ¸…ç†ä»»åŠ¡...
2025-09-08 15:30:01 - INFO - æ¸…ç† streams ç›®å½•...
2025-09-08 15:30:02 - INFO - å·²åˆ é™¤è¿‡æœŸæ–‡ä»¶: streams/camera1/segment_001.ts (å¤§å°: 1024000 bytes)
2025-09-08 15:30:03 - INFO - ç›®å½• streams æ¸…ç†å®Œæˆ: åˆ é™¤ 5 ä¸ªæ–‡ä»¶, é‡Šæ”¾ 5120000 bytes
2025-09-08 15:30:04 - INFO - å®šæ—¶æ¸…ç†ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶: 4.23 ç§’
```

## æ•…éšœæ’é™¤

### 1. æ¸…ç†æœåŠ¡æœªå¯åŠ¨
```bash
# æ£€æŸ¥Pythonä¾èµ–
pip install schedule

# æ‰‹åŠ¨å¯åŠ¨æ¸…ç†æœåŠ¡
python cleanup_temp_files.py --daemon
```

### 2. æƒé™é—®é¢˜
```bash
# Linux/Mac: ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x cleanup_temp_files.py
chmod +x start_cleanup.sh
```

### 3. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# ç«‹å³æ‰§è¡Œæ¸…ç†
python cleanup_temp_files.py --once

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
python cleanup_temp_files.py --report
```

### 4. æ¸…ç†è¿‡äºé¢‘ç¹
ä¿®æ”¹ `cleanup_config.json` ä¸­çš„ `interval_minutes` å€¼ï¼Œå¢åŠ æ¸…ç†é—´éš”ã€‚

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é‡è¦æ–‡ä»¶**: æ¸…ç†å‰ç¡®ä¿é‡è¦æ–‡ä»¶å·²å¤‡ä»½
2. **æµ‹è¯•æ¨¡å¼**: é¦–æ¬¡ä½¿ç”¨å»ºè®®å¼€å¯ `dry_run` æ¨¡å¼
3. **ç›‘æ§æ—¥å¿—**: å®šæœŸæ£€æŸ¥æ¸…ç†æ—¥å¿—ï¼Œç¡®ä¿æ¸…ç†æ­£å¸¸
4. **æƒé™æ§åˆ¶**: ç¡®ä¿æ¸…ç†è„šæœ¬æœ‰é€‚å½“çš„æ–‡ä»¶ç³»ç»Ÿæƒé™

## è‡ªå®šä¹‰æ¸…ç†è§„åˆ™

### æ·»åŠ æ–°çš„æ¸…ç†ç›®å½•
åœ¨ `cleanup_config.json` ä¸­æ·»åŠ æ–°çš„ç›®å½•é…ç½®ï¼š

```json
{
  "directories": {
    "custom_dir": {
      "path": "custom_directory",
      "enabled": true,
      "max_age_hours": 24,
      "extensions": [".custom", ".tmp"],
      "description": "è‡ªå®šä¹‰ç›®å½•"
    }
  }
}
```

### ä¿®æ”¹æ¸…ç†æ—¶é—´
```json
{
  "schedules": {
    "custom_cleanup": {
      "interval_minutes": 60,
      "enabled": true,
      "description": "æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡"
    }
  }
}
```

## ç›‘æ§å’Œç»´æŠ¤

### å®šæœŸæ£€æŸ¥
- æ¯å‘¨æ£€æŸ¥æ¸…ç†æ—¥å¿—
- ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
- éªŒè¯æ¸…ç†æ•ˆæœ

### æ€§èƒ½ä¼˜åŒ–
- æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´æ¸…ç†é¢‘ç‡
- ä¼˜åŒ–æ–‡ä»¶ä¿ç•™æ—¶é—´
- ç›‘æ§æ¸…ç†æœåŠ¡çš„èµ„æºä½¿ç”¨

## è”ç³»æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ¸…ç†æ—¥å¿—æ–‡ä»¶
2. æ£€æŸ¥é…ç½®æ–‡ä»¶è®¾ç½®
3. éªŒè¯æ–‡ä»¶ç³»ç»Ÿæƒé™
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ
